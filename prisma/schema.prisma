// Prisma schema for AI Resume application
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

model UserSync {
  id                     String    @id
  email                  String    @unique
  name                   String
  clerkUserId            String?   @unique @map("clerk_user_id")
  subscriptionStatus     String    @default("free") @map("subscription_status")
  subscriptionPlan       String    @default("free") @map("subscription_plan")
  subscriptionPeriodEnd  DateTime? @map("subscription_period_end")
  polarCustomerId        String?   @unique @map("polar_customer_id")
  polarSubscriptionId    String?   @unique @map("polar_subscription_id")
  beehiivSubscriberId    String?   @map("beehiiv_subscriber_id")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  deletedAt              DateTime? @map("deleted_at")

  resumes                   Resume[]
  resumeVersions            ResumeVersion[]
  jobAnalyses               JobAnalysis[]
  jobApplications           JobApplication[]
  pendingPolarSubscriptions PendingPolarSubscription[]

  @@index([clerkUserId])
  @@map("users_sync")
  @@schema("public")
}

model Resume {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String    @map("user_id")
  title            String    @db.VarChar(255)
  fileName         String    @map("file_name") @db.VarChar(255)
  fileUrl          String    @map("file_url")
  fileType         String    @map("file_type") @db.VarChar(50)
  fileSize         Int       @map("file_size")
  fileHash         String?   @map("file_hash") @db.VarChar(64)
  kind             String    @default("uploaded") @db.VarChar(32)
  processingStatus String    @default("pending") @map("processing_status") @db.VarChar(32)
  processingError  String?   @map("processing_error")
  parsedSections   Json?     @map("parsed_sections")
  parsedStructure  Json?     @map("parsed_structure")
  parsedAt         DateTime? @map("parsed_at")
  extractedAt      DateTime? @map("extracted_at")
  sourceMetadata   Json?     @map("source_metadata")
  isPrimary        Boolean   @default(false) @map("is_primary")
  warnings         String[]  @default([])
  modeUsed         String?   @map("mode_used") @db.VarChar(50)
  truncated        Boolean   @default(false)
  pageCount        Int?      @map("page_count")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  user            UserSync         @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobApplications JobApplication[]
  versions        ResumeVersion[]

  @@index([userId])
  @@index([createdAt])
  @@index([kind])
  @@index([processingStatus])
  @@index([fileHash])
  @@map("resumes")
  @@schema("public")
}

model ResumeVersion {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id")
  resumeId      String   @map("resume_id") @db.Uuid
  kind          String   @db.VarChar(32)
  version       Int
  fileName      String   @map("file_name") @db.VarChar(255)
  fileType      String   @map("file_type") @db.VarChar(50)
  fileSize      Int      @map("file_size")
  fileHash      String   @map("file_hash") @db.VarChar(64)
  storageKey    String   @map("storage_key")
  metadata      Json?    @map("metadata")
  changeType    String   @map("change_type") @db.VarChar(32)
  changeSummary String?  @map("change_summary")
  createdAt     DateTime @default(now()) @map("created_at")

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  user   UserSync @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([kind])
  @@index([resumeId])
  @@map("resume_versions")
  @@schema("public")
}

model JobAnalysis {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String    @map("user_id")
  jobUrl            String?   @map("job_url")
  jobTitle          String    @map("job_title") @db.VarChar(255)
  companyName       String    @map("company_name") @db.VarChar(255)
  jobDescription    String?   @map("job_description")
  parsedData        Json?     @map("parsed_data")
  requirements      String[]  @default([])
  preferredSkills   String[]  @default([]) @map("preferred_skills")
  experienceLevel   String?   @map("experience_level") @db.VarChar(50)
  employmentType    String?   @map("employment_type") @db.VarChar(50)
  location          String?   @db.VarChar(255)
  salaryRangeMin    Int?      @map("salary_range_min")
  salaryRangeMax    Int?      @map("salary_range_max")
  salaryCurrency    String?   @map("salary_currency") @db.VarChar(3)
  benefits          String[]  @default([])
  companySize       String?   @map("company_size") @db.VarChar(50)
  industry          String?   @db.VarChar(100)
  keywords          String[]  @default([])
  analyzedAt        DateTime? @map("analyzed_at")
  extractionMethod  String?   @map("extraction_method") @db.VarChar(50)
  processingError   String?   @map("processing_error")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  user UserSync @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, jobTitle, companyName])
  @@index([userId])
  @@index([createdAt])
  @@map("job_analysis")
  @@schema("public")
}

model JobApplication {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @map("user_id")
  resumeId       String    @map("resume_id") @db.Uuid
  jobTitle       String    @map("job_title") @db.VarChar(255)
  companyName    String    @map("company_name") @db.VarChar(255)
  jobUrl         String?   @map("job_url")
  jobDescription String?   @map("job_description")
  status         String    @default("pending") @db.VarChar(50)
  appliedAt      DateTime  @default(now()) @map("applied_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user   UserSync @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resumeId])
  @@map("job_applications")
  @@schema("public")
}

model LeadMagnetSubmission {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email               String
  originalFileName    String    @map("original_file_name") @db.VarChar(255)
  originalFileUrl     String    @map("original_file_url")
  originalFileHash    String?   @map("original_file_hash") @db.VarChar(64)
  optimizedFileUrl    String?   @map("optimized_file_url")
  optimizedFileHash   String?   @map("optimized_file_hash") @db.VarChar(64)
  status              String    @default("pending") @db.VarChar(32)
  processingError     String?   @map("processing_error")
  improvementsSummary Json?     @map("improvements_summary")
  ipAddress           String?   @map("ip_address") @db.VarChar(45)
  userAgent           String?   @map("user_agent")
  downloadExpiresAt   DateTime? @map("download_expires_at")
  emailSentAt         DateTime? @map("email_sent_at")
  downloadedAt        DateTime? @map("downloaded_at")
  convertedToUser     Boolean   @default(false) @map("converted_to_user")
  submittedAt         DateTime  @default(now()) @map("submitted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([ipAddress])
  @@map("lead_magnet_submissions")
  @@schema("public")
}

model PendingPolarSubscription {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  polarSubscriptionId  String    @unique @map("polar_subscription_id")
  polarCustomerId      String    @map("polar_customer_id")
  polarCheckoutId      String?   @map("polar_checkout_id")
  customerEmail        String    @map("customer_email")
  customerName         String?   @map("customer_name")
  planType             String    @default("pro") @map("plan_type") @db.VarChar(50)
  status               String    @db.VarChar(50)
  amount               Int
  currency             String    @default("USD") @db.VarChar(3)
  recurringInterval    String?   @map("recurring_interval") @db.VarChar(20)
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  linkedUserId         String?   @map("linked_user_id")
  linkedAt             DateTime? @map("linked_at")
  rawWebhookData       Json?     @map("raw_webhook_data")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  linkedUser UserSync? @relation(fields: [linkedUserId], references: [id], onDelete: SetNull)

  @@index([customerEmail])
  @@index([linkedUserId])
  @@index([polarCustomerId])
  @@index([status])
  @@map("pending_polar_subscriptions")
  @@schema("public")
}
